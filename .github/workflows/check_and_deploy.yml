name: Check for Docker Image Update and Deploy

on:
  # æ¯å¤©çš„æ¯ä¸ªå°æ—¶çš„ç¬¬15åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ (å¯ä»¥è‡ªå·±è°ƒæ•´)
  schedule:
    - cron: '15 * * * *'
  # ä¹Ÿå…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿æµ‹è¯•
  workflow_dispatch:

# ç¯å¢ƒå˜é‡ï¼Œè¯·ä¿®æ”¹ä¸ºæ‚¨è¦ç›‘æ§çš„é•œåƒ
env:
  IMAGE_TO_CHECK: "jellyfin/jellyfin" # <--- âš ï¸ ä¿®æ”¹ä¸ºæ‚¨è¦ç›‘æ§çš„é•œåƒå

jobs:
  check-for-update:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1: æ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼Œè¿™æ ·æ‰èƒ½è¯»å†™ last_digest.txt æ–‡ä»¶
      - name: Checkout Repo
        uses: actions/checkout@v3

      # æ­¥éª¤2: è¯»å–ä¸Šä¸€æ¬¡è®°å½•çš„é•œåƒDigest
      - name: Read Last Known Digest
        id: last_digest
        run: echo "digest=$(cat last_digest.txt)" >> $GITHUB_OUTPUT

      # æ­¥éª¤3: ä»Docker Hubè·å–æœ€æ–°çš„é•œåƒDigest
      # è¿™æ˜¯æ•´ä¸ªè„šæœ¬çš„æ ¸å¿ƒï¼Œå®ƒé€šè¿‡APIæŸ¥è¯¢é•œåƒä¿¡æ¯
      - name: Get Latest Image Digest from Docker Hub
        id: new_digest
        run: |
          TOKEN=$(curl -s "https://auth.docker.io/token?service=registry.docker.io&scope=repository:${{ env.IMAGE_TO_CHECK }}:pull" | jq -r .token)
          DIGEST=$(curl -s -H "Accept: application/vnd.docker.distribution.manifest.v2+json" -H "Authorization: Bearer $TOKEN" "https://registry-1.docker.io/v2/${{ env.IMAGE_TO_CHECK }}/manifests/latest" | grep -o 'sha256:[a-f0-9]*' | head -n 1)
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          echo "Latest digest for ${{ env.IMAGE_TO_CHECK }} is ${DIGEST}"

      # æ­¥éª¤4: æ¯”è¾ƒæ–°æ—§Digestï¼Œå¦‚æœä¸åŒï¼Œåˆ™è§¦å‘éƒ¨ç½²
      - name: Compare Digests and Trigger Deploy
        if: steps.last_digest.outputs.digest != steps.new_digest.outputs.digest
        run: |
          echo "âœ… New image found! Old: ${{ steps.last_digest.outputs.digest }}, New: ${{ steps.new_digest.outputs.digest }}"
          echo "Triggering Claw Cloud redeployment..."
          curl -X POST "${{ secrets.CLAWCLOUD_DEPLOY_HOOK }}"
          echo "Deployment triggered."

          echo "Updating last_digest.txt with new digest..."
          echo "${{ steps.new_digest.outputs.digest }}" > last_digest.txt
          
          # é…ç½®Gitï¼Œä»¥ä¾¿èƒ½å°†æ–°Digestå†™å›ä»“åº“
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add last_digest.txt
          git commit -m "Update image digest to ${{ steps.new_digest.outputs.digest }}"
          git push
        
      # å¦‚æœDigestç›¸åŒï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åš
      - name: No Update Found
        if: steps.last_digest.outputs.digest == steps.new_digest.outputs.digest
        run: echo "ğŸ‘ Image is up to date. No action needed."
