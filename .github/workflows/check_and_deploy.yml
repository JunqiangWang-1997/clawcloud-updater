name: Check GHCR Image Update and Deploy

on:
  # æ¯å°æ—¶çš„ç¬¬30åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ (æ‚¨å¯ä»¥è‡ªå·±è°ƒæ•´)
  schedule:
    - cron: '30 * * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿æ‚¨éšæ—¶æµ‹è¯•
  workflow_dispatch:

# --- âš ï¸ è¯·åœ¨è¿™é‡Œä¿®æ”¹ä¸ºæ‚¨è¦ç›‘æ§çš„é•œåƒ ---
env:
  IMAGE_TO_CHECK: "moontechlab/lunatv" # åªéœ€è¦ "ç»„ç»‡å/é•œåƒå"
  IMAGE_TAG: "latest"                  # é•œåƒçš„æ ‡ç­¾
# ------------------------------------

jobs:
  check-for-update:
    runs-on: ubuntu-latest
    # ç»™å·¥ä½œæµèµ‹äºˆè¯»å–å…¬å…±åŒ…å’Œå†™å…¥æœ¬ä»“åº“å†…å®¹çš„æƒé™
    permissions:
      packages: read
      contents: write
      
    steps:
      # æ­¥éª¤1: æ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼Œè¿™æ ·æ‰èƒ½è¯»å†™ last_digest.txt æ–‡ä»¶
      - name: Checkout Repo
        uses: actions/checkout@v4

      # æ­¥éª¤2: è¯»å–ä¸Šä¸€æ¬¡è®°å½•çš„é•œåƒDigest (å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¸ºç©º)
      - name: Read Last Known Digest
        id: last_digest
        run: |
          if [ -f last_digest.txt ]; then
            echo "digest=$(cat last_digest.txt)" >> $GITHUB_OUTPUT
          else
            echo "digest=''" >> $GITHUB_OUTPUT
          fi

      # æ­¥éª¤3: ä» GHCR è·å–æœ€æ–°çš„é•œåƒ Digest
      # è¿™æ˜¯é’ˆå¯¹ GHCR ä¿®æ”¹åçš„æ ¸å¿ƒæ­¥éª¤
      - name: Get Latest Image Digest from GHCR
        id: new_digest
        run: |
          DIGEST=$(curl -sIL -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                        -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
                        "https://ghcr.io/v2/${{ env.IMAGE_TO_CHECK }}/manifests/${{ env.IMAGE_TAG }}" \
                        | grep -i 'Docker-Content-Digest' | awk '{print $2}' | tr -d '\r')

          if [ -z "$DIGEST" ]; then
            echo "::error::Failed to fetch image digest. Check image name (ghcr.io/${{ env.IMAGE_TO_CHECK }}:${{ env.IMAGE_TAG }}) and permissions."
            exit 1
          fi

          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          echo "Latest digest for ghcr.io/${{ env.IMAGE_TO_CHECK }}:${{ env.IMAGE_TAG }} is ${DIGEST}"

      # æ­¥éª¤4: æ¯”è¾ƒæ–°æ—§Digestï¼Œå¦‚æœä¸åŒï¼Œåˆ™è§¦å‘éƒ¨ç½²
      - name: Compare Digests and Trigger Deploy
        if: steps.last_digest.outputs.digest != steps.new_digest.outputs.digest
        run: |
          echo "âœ… New image found! Old: ${{ steps.last_digest.outputs.digest }}, New: ${{ steps.new_digest.outputs.digest }}"
          echo "Triggering Claw Cloud redeployment..."
          curl -X POST "${{ secrets.CLAWCLOUD_DEPLOY_HOOK }}"
          echo "Deployment triggered."

          echo "Updating last_digest.txt with new digest..."
          echo "${{ steps.new_digest.outputs.digest }}" > last_digest.txt
          
          # é…ç½®Gitï¼Œä»¥ä¾¿èƒ½å°†æ–°Digestå†™å›ä»“åº“
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add last_digest.txt
          git commit -m "Update image digest for ${{ env.IMAGE_TO_CHECK }}"
          git push
        
      # å¦‚æœDigestç›¸åŒï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åš
      - name: No Update Found
        if: steps.last_digest.outputs.digest == steps.new_digest.outputs.digest
        run: echo "ğŸ‘ Image is up to date (Digest: ${{ steps.new_digest.outputs.digest }}). No action needed."
