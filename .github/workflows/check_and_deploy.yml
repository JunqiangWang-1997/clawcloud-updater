name: Check GHCR Image and Redeploy via Claw Cloud API

on:
  schedule:
    # æ¯å¤©çš„æ¯ä¸ªå°æ—¶çš„ç¬¬5åˆ†é’Ÿæ‰§è¡Œ (æ‚¨å¯ä»¥è‡ªå·±è°ƒæ•´)
    - cron: '5 * * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿æ‚¨éšæ—¶æµ‹è¯•
  workflow_dispatch:

# --- âš ï¸ è¯·åœ¨è¿™é‡Œä¿®æ”¹ä¸ºæ‚¨è¦ç›‘æ§çš„é•œåƒ ---
env:
  IMAGE_TO_CHECK: "moontechlab/lunatv"
  IMAGE_TAG: "latest"
# ------------------------------------

jobs:
  check-and-redeploy:
    runs-on: ubuntu-latest
    permissions:
      packages: read
      contents: write

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»“åº“ä»£ç ï¼Œä»¥è¯»å†™ last_digest.txt
      - name: Checkout Repo
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: è¯»å–ä¸Šä¸€æ¬¡è®°å½•çš„é•œåƒ Digest
      - name: Read Last Known Digest
        id: last_digest
        run: |
          if [ -f last_digest.txt ]; then echo "digest=$(cat last_digest.txt)" >> $GITHUB_OUTPUT; else echo "digest=''" >> $GITHUB_OUTPUT; fi

      # æ­¥éª¤ 3: ä» GHCR è·å–æœ€æ–°çš„é•œåƒ Digest
      - name: Get Latest Image Digest from GHCR
        id: new_digest
        run: |
          DIGEST=$(curl -sIL -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/vnd.docker.distribution.manifest.v2+json" "https://ghcr.io/v2/${{ env.IMAGE_TO_CHECK }}/manifests/${{ env.IMAGE_TAG }}" | grep -i 'Docker-Content-Digest' | awk '{print $2}' | tr -d '\r')
          if [ -z "$DIGEST" ]; then echo "::error::Failed to fetch image digest."; exit 1; fi
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          echo "Latest digest for ghcr.io/${{ env.IMAGE_TO_CHECK }} is ${DIGEST}"

      # æ­¥éª¤ 4: æ¯”è¾ƒ Digestï¼Œå¦‚æœä¸åŒï¼Œåˆ™æ‰§è¡Œéƒ¨ç½²
      - name: Compare, Login, and Redeploy if Needed
        if: steps.last_digest.outputs.digest != steps.new_digest.outputs.digest
        # ä½¿ç”¨ jq å·¥å…·æ¥å¤„ç† JSON æ•°æ®
        run: |
          echo "âœ… New image found! Triggering Claw Cloud redeployment via private API..."

          # 1. æ¨¡æ‹Ÿç™»å½• Claw Cloud API è·å–åŒ…å« kubeconfig å’Œ token çš„æˆæƒå¯¹è±¡
          # è¿™ä¸ª API ç«¯ç‚¹æ˜¯æ ¹æ®é€šç”¨å®è·µçŒœæµ‹çš„ï¼Œå¦‚æœå¤±æ•ˆï¼Œéœ€è¦åœ¨å¼€å‘è€…å·¥å…·ä¸­æ‰¾åˆ°ç™»å½•è¯·æ±‚çš„URL
          AUTH_PAYLOAD=$(curl -s -X POST 'https://www.clawcloud.net/api/login' \
            -H 'Content-Type: application/json' \
            -d '{"username": "${{ secrets.CLAW_CLOUD_USERNAME }}", "password": "${{ secrets.CLAW_CLOUD_PASSWORD }}"}')

          # æ£€æŸ¥ç™»å½•æ˜¯å¦æˆåŠŸï¼Œä»¥åŠæ˜¯å¦è¿”å›äº†éœ€è¦çš„ kubeconfig å’Œ token
          if ! echo "$AUTH_PAYLOAD" | jq -e '.data.kubeconfig' > /dev/null || ! echo "$AUTH_PAYLOAD" | jq -e '.data.token' > /dev/null; then
            echo "::error::Login failed or did not receive valid auth payload from Claw Cloud API."
            echo "API Response: $AUTH_PAYLOAD"
            exit 1
          fi
          
          # 2. ä»ç™»å½•å“åº”ä¸­æå–å®Œæ•´çš„æˆæƒå¯¹è±¡ï¼ˆåŒ…å« kubeconfig å’Œ tokenï¼‰
          AUTHORIZATION_JSON=$(echo "$AUTH_PAYLOAD" | jq -c '.data')

          # 3. ç”Ÿæˆå½“å‰çš„UTCæ—¶é—´æˆ³ï¼Œæ ¼å¼ä¸º YYYYMMDDHHMMSS
          RESTART_TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
          
          # 4. ä½¿ç”¨ jq ç²¾ç¡®æ„å»ºæˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­æ•è·åˆ°çš„ patch æ•°æ®
          # æˆ‘ä»¬å°† CLAW_CLOUD_PROJECT_NAME å’Œæ–°çš„æ—¶é—´æˆ³åŠ¨æ€æ³¨å…¥
          REDEPLOY_PAYLOAD=$(jq -n \
            --arg appName "${{ secrets.CLAW_CLOUD_PROJECT_NAME }}" \
            --arg restartTime "$RESTART_TIMESTAMP" \
            '{
              appName: $appName,
              patch: [
                {
                  type: "patch",
                  kind: "Deployment",
                  value: {
                    spec: {
                      template: {
                        metadata: {
                          labels: {
                            restartTime: $restartTime
                          }
                        }
                      }
                    }
                  }
                }
              ]
            }')

          # 5. å‘é€æœ€ç»ˆçš„ updateApp è¯·æ±‚ï¼
          curl -s -X POST 'https://applaunchpad.ap-northeast-1.run.claw.cloud/api/updateApp' \
            -H 'Content-Type: application/json' \
            -H "Authorization: $(echo $AUTHORIZATION_JSON | jq -r tostring | jq -sRr @uri)" \
            -d "$REDEPLOY_PAYLOAD"

          echo "Redeploy API call sent with restartTime ${RESTART_TIMESTAMP}."
          
          # 6. æ›´æ–°æœ¬åœ°çš„ digest æ–‡ä»¶ä»¥å¤‡ä¸‹æ¬¡æ£€æŸ¥
          echo "Updating digest file..."
          echo "${{ steps.new_digest.outputs.digest }}" > last_digest.txt
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add last_digest.txt
          git commit -m "Update image digest for ${{ env.IMAGE_TO_CHECK }}"
          git push
        env:
          CLAW_CLOUD_USERNAME: ${{ secrets.CLAW_CLOUD_USERNAME }}
          CLAW_CLOUD_PASSWORD: ${{ secrets.CLAW_CLOUD_PASSWORD }}
          CLAW_CLOUD_PROJECT_NAME: ${{ secrets.CLAW_CLOUD_PROJECT_NAME }}

      # å¦‚æœ Digest ç›¸åŒï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åš
      - name: No Update Found
        if: steps.last_digest.outputs.digest == steps.new_digest.outputs.digest
        run: echo "ğŸ‘ Image is up to date (Digest: ${{ steps.new_digest.outputs.digest }}). No action needed."
